#!/bin/bash
# run_api.sh: OpenAI Key ì„¤ì • + Chroma ì„œë²„ í™•ì¸ + FastAPI ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ 8000)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. .envì—ì„œ OPENAI_API_KEY ë¡œë”©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f .env ]; then
  set -o allexport
  source .env
  set +o allexport
  echo "[â„¹ï¸] .envì˜ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤"
else
  echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € setup_env.shë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
  exit 1
fi


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Chroma ì„œë²„ê°€ ì‚´ì•„ë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "[ðŸ•“] Chroma ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘..."

MAX_RETRIES=30
RETRY_INTERVAL=2
COUNTER=0

while ! curl -s http://localhost:9000 > /dev/null; do
  ((COUNTER++))
  echo "ðŸ” Chromaê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ ($COUNTER/$MAX_RETRIES). ${RETRY_INTERVAL}ì´ˆ í›„ ìž¬ì‹œë„..."
  if [ "$COUNTER" -ge "$MAX_RETRIES" ]; then
    echo "âŒ Chroma ì„œë²„ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•„ FastAPIë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi
  sleep $RETRY_INTERVAL
done

echo "[âœ…] Chroma ì„œë²„ ì—°ê²° ì„±ê³µ!"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. FastAPI ì„œë²„ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "[ðŸš€] FastAPI ì„œë²„ ì‹¤í–‰ ì¤‘... (í¬íŠ¸ 8000)"
nohup uvicorn app.main:app  --host 0.0.0.0 --port 8000 > fastapi.log 2>&1 &

echo "ðŸŽ‰ API ì„œë²„ ì‹¤í–‰ ì™„ë£Œ!"